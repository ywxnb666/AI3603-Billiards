# CueCard 算法架构总结

基于 *Analysis of a Winning Computational Billiards Player* 及相关博士论文的分析，CueCard 是 2008 年计算机奥林匹克台球比赛的冠军程序。其核心架构是一个专为连续动作空间、存在执行误差（噪声）和随机性的博弈环境设计的**概率搜索与分布式计算决策系统**。

---

## 1. 总体决策流程 (Decision Pipeline)

CueCard 的决策是一个从无限连续空间中筛选最优解的多阶段过程。

### **Step 1: 候选击球生成 (Candidate Generation)**
* **输入**：当前的台面球势。
* **逻辑**：遍历所有合法的“目标球-袋口”组合。
* **参数生成**：计算标称的击球方向 ($\phi$) 和最小必要速度 ($v_0$)。
* **类型覆盖**：
    * 直线球 (Straight-in)
    * 翻袋球 (Bank)
    * 反弹球 (Kick)
    * 组合球 (Combination)
    * *特例*：保留能炸散球堆的直线球，过滤掉有明显阻挡的路线。

### **Step 2: 初步筛选与离散化**
* **速度采样**：对每个方向生成多个离散的速度值 ($v_i$)。
* **无噪声过滤**：在无噪声环境下快速模拟，剔除无法进球的“不可行”击球方案。

### **Step 3: 一级搜索 (Level 1 Search)**
* **参数微调**：随机生成具体的击球点 ($a, b$) 和球杆角度 ($\theta$)。
* **带噪声模拟 (Noisy Simulation)**：
    * 对每个候选击球模拟 **25-100 次**。
    * 加入高斯噪声以模拟真实的执行误差。
* **评分**：利用启发式函数对模拟结果取平均分。

### **Step 4: 状态聚类 (State Clustering) —— *核心创新***
* **问题**：单次击球在噪声下会产生发散的多种结果状态。
* **解决方案**：不保留所有结果，而是使用聚类算法将相似状态归组。
* **聚类标准**：结合 **球的位置 $(x, y)$** 和 **状态评分**。
* **输出**：提取 5-10 个“代表性状态” (Representative State) 进入下一层，大幅降低分支因子。

### **Step 5: 二级搜索 (Level 2 Search)**
* **筛选**：仅选取一级搜索中表现最好的前 20 种击球变体。
* **深化推演**：从“代表性状态”出发继续搜索。
    * **常规阶段**：重复一级搜索逻辑（生成、模拟、评分）。
    * **晚期阶段 (Endgame)**：切换为 **无噪声搜索 (Noiseless Search)**，直接推演至游戏结束，计算获胜概率。

### **Step 6: 最终决策**
* 根据二级搜索修正后的评分，选择最佳击球参数提交。

---

## 2. 核心算法组件

### **A. 状态评估函数 (State Evaluation Function)**
* **核心逻辑**：好的状态 = 拥有更多容易打进的直线球。
* **公式**：$$Score = 1.0 p_0 + 0.33 p_1 + 0.15 p_2 \dots$$
    * $p_i$：按概率排序的直线球进球概率。
    * *特点*：奖励能产生多个进攻机会（如炸散球堆）的局面。

### **B. 状态聚类技术**
* **目的**：解决连续空间中蒙特卡洛采样导致的搜索树爆炸问题。
* **优势**：避免将“几何位置相近”但“局势天差地别”（如母球被阻挡）的状态错误合并。

### **C. 分布式架构 (Distributed Architecture)**
* **架构**：主从式 (Master-Worker)。
* **规模**：约 20 台双核机器 (Amazon EC2)。
* **分工**：
    * **Manager**：任务分发、时间管理、最终决策。
    * **Workers**：并行处理 Level 1 & Level 2 的模拟任务。
* **时间管理**：根据剩余球数动态分配每一步的思考时间（10分钟总时限）。

---

## 3. 特殊情境处理模块

| 情境 | 策略描述 | 核心考量 |
| :--- | :--- | :--- |
| **开球 (Break Shot)** | 使用**预计算**的最优参数，不进行实时搜索。 | 优先保证**保留球权 (Keep Turn)** (92% 成功率)，而非盲目追求炸散。 |
| **自由球 (Ball-in-hand)** | 将母球放置在**极度靠近**目标球的位置。 | 最小化角度误差，确保必进。 |
| **最后一搏 (Last Resort)** | 当常规搜索无解时，尝试全方位的满力击球。 | 寻找不犯规线路（如多库解球），同时评估防守价值 ($v_{CC} - v_{OPP}$)。 |

---

## 4. 物理引擎优化
* **重写引擎**：团队重写了物理模拟器，速度比官方库快 **5.9 倍**。
* **精度校验**：仅在快速引擎结果与官方引擎偏差极小时使用，确保模拟的有效性。